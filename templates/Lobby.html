{% extends 'base.html' %}

{% block title %}Лобі DRA{% endblock %}
{% block header_title %}Лобі кампаній{% endblock %}

{% block content %}
{% if not member_lobbies %}
    <section class="grid">
        <article class="card">
            <h2>Створення лобі</h2>
            <p class="muted">Лише адміністратори можуть створювати нові лобі з унікальним ключем доступу.</p>
            <form method="post" class="form inline">
                <input type="hidden" name="action" value="create">
                <input type="text" name="name" placeholder="Назва лобі" required>
                <button type="submit" class="button" {% if not user.is_admin %}disabled{% endif %}>Створити</button>
            </form>
            {% if not user.is_admin %}
                <p class="hint">Потрібен адмін-доступ? Зверніться до майстра кампанії.</p>
            {% endif %}
        </article>

        <article class="card">
            <h2>Приєднатись за ключем</h2>
            <form method="post" class="form">
                <input type="hidden" name="action" value="join">
                <label for="access_key">Ключ доступу</label>
                <input type="text" id="access_key" name="access_key" placeholder="A1B2C3" required>
                <button type="submit" class="button">Увійти</button>
            </form>
        </article>
    </section>
{% endif %}

<section class="stack">
    {% if member_lobbies %}
        {% set role_labels = {'master': 'Майстер', 'player': 'Гравець', 'spectator': 'Глядач'} %}
        {% for membership in member_lobbies %}
            <div class="lobby-card">
                <div>
                    <h1>Ваше лобі</h1>
                    <strong>{{ membership.lobby.name }}</strong>
                    <p class="muted">Ключ: {{ membership.lobby.access_key }}</p>
                    <p class="muted">Учасників: {{ membership.lobby.members | length }}</p>
                </div>
                {% if membership.lobby.admin_id != user.id %}
                    <form method="post">
                        <input type="hidden" name="action" value="leave">
                        <input type="hidden" name="lobby_id" value="{{ membership.lobby.id }}">
                        <button type="submit" class="button ghost">Вийти</button>
                    </form>
                {% else %}
                    <span class="badge">Адмін</span>
                {% endif %}
            </div>
            <div class="lobby-layout">
                <div class="lobby-side">
                    <div class="lobby-members">
                        {% for member in membership.lobby.members %}
                            <details class="member-card">
                                <summary class="member-card__summary">
                                    {% if member.user.userImage %}
                                        <img src="{{ url_for('static', filename=static_path(member.user.userImage)) }}" alt="avatar" class="avatar avatar--mini {% if member.user.is_online %}avatar--online{% else %}avatar--offline{% endif %}">
                                    {% else %}
                                        <img src="/static/images/default_avatar.png" alt="Аватар" class="avatar avatar--mini {% if member.user.is_online %}avatar--online{% else %}avatar--offline{% endif %}">
                                    {% endif %}
                                    <span>{{ member.user.nickname }}</span>
                                </summary>
                                <div class="member-card__details">
                                    <strong>{{ member.user.nickname }}</strong>
                                    <p class="muted">{{ member.user.description or 'Опис ще не додано.' }}</p>
                                    <div class="chip-grid">
                                        <span class="chip">{{ role_labels.get(member.role, member.role) }}</span>
                                        {% if member.user.description %}
                                            <span class="chip">Профіль: оновлено</span>
                                        {% else %}
                                            <span class="chip">Профіль: без опису</span>
                                        {% endif %}
                                    </div>
                                    {% if membership.lobby.admin_id == user.id and member.user_id != user.id %}
                                        <form method="post" class="form inline">
                                            <input type="hidden" name="action" value="set_role">
                                            <input type="hidden" name="lobby_id" value="{{ membership.lobby.id }}">
                                            <input type="hidden" name="member_id" value="{{ member.id }}">
                                            <select name="role">
                                                <option value="master" {% if member.role == 'master' %}selected{% endif %}>Майстер</option>
                                                <option value="player" {% if member.role == 'player' %}selected{% endif %}>Гравець</option>
                                                <option value="spectator" {% if member.role == 'spectator' %}selected{% endif %}>Глядач</option>
                                            </select>
                                            <button type="submit" class="button ghost">Оновити</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </details>
                        {% endfor %}
                        {% if membership.lobby.admin_id == user.id %}
                            <form method="post">
                                <input type="hidden" name="action" value="delete_lobby">
                                <input type="hidden" name="lobby_id" value="{{ membership.lobby.id }}">
                                <button type="submit" class="button danger">Видалити лобі</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                <div class="lobby-workspace card" aria-label="Поле для роботи"></div>
            </div>
        {% endfor %}
    {% else %}
        <p class="muted">Ще немає активних лобі. Попросіть ключ у майстра.</p>
    {% endif %}
</section>
{% endblock %}
